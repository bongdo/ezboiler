<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ç–ª–æ–≤ | EzBoiler</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <span>–≥. –í–ª–∞–¥–∏–º–∏—Ä, —É–ª. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ, 9</span>
            <div style="display: flex; gap: 1rem;">
                <a href="#" style="color: white; text-decoration: none;">WhatsApp</a>
                <a href="#" style="color: white; text-decoration: none;">Telegram</a>
                <a href="mailto:info@ezboiler.ru" style="color: white; text-decoration: none;">Email</a>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header>
        <div class="main-header">
            <div class="container">
                <a href="/" class="logo">EzBoiler</a>
                
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é...">
                    <span class="search-icon">üîç</span>
                </div>

                <div class="cart-icon" id="cartBtn">
                    üõí
                    <span class="cart-count">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        
        <!-- Controls -->
        <div class="controls">
            <div class="toggle-group" id="viewModeToggle">
                <button class="toggle-btn active" data-mode="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
                <button class="toggle-btn" data-mode="brands">–ü–æ –±—Ä–µ–Ω–¥–∞–º</button>
                <button class="toggle-btn" data-mode="types">–ü–æ —Ç–∏–ø—É</button>
            </div>
            
            <select id="brandFilter" class="toggle-btn" style="border: 1px solid #e5e5e5;">
                <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
            </select>
        </div>

        <div id="contentGrid" class="grid">
            <!-- Content will be injected here -->
             <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
        </div>

    </main>

    <!-- Footer -->
    <footer>
        <div class="container footer-grid">
            <div class="footer-col">
                <h3>–ö–û–ù–¢–ê–ö–¢–´</h3>
                <a href="tel:+74922552288" class="contact-highlight">+7 (4922) 55-22-88</a>
                <a href="tel:+79913210733" class="contact-highlight">+7 (991) 321-07-33</a>
                <p style="margin-top: 1rem;">–≥. –í–ª–∞–¥–∏–º–∏—Ä,<br>—É–ª. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ, 9</p>
                <div style="margin-top: 1rem;">
                    <a href="#">WhatsApp</a>
                    <a href="#">Telegram</a>
                    <a href="mailto:info@ezboiler.ru">Email</a>
                </div>
            </div>

            <div class="footer-col">
                <h3>–ò–ù–§–û–†–ú–ê–¶–ò–Ø</h3>
                <a href="#">–£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏</a>
                <a href="#">–ü—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</a>
                <a href="#">–í–æ–∑–≤—Ä–∞—Ç</a>
                <a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
            </div>

            <div class="footer-col">
                <h3>–ö–ê–¢–ê–õ–û–ì</h3>
                <a href="#">–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ç–ª–æ–≤</a>
                <a href="#">–ü—Ä–æ–º—ã–≤–∫–∞ —Å–∏—Å—Ç–µ–º</a>
                <a href="#">–£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
            </div>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import firebaseConfig from './config.js';

        let db;
        let allProducts = [];
        let brands = [];

        // Init App
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            init();
        } catch (e) {
            console.error("Firebase init failed:", e);
            document.getElementById('contentGrid').innerHTML = `<div class="loader" style="color: red;">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ config.js</div>`;
        }

        async function init() {
            await Promise.all([fetchBrands(), fetchProducts()]);
            renderProducts(allProducts);
        }

        async function fetchBrands() {
            try {
                const snap = await getDocs(collection(db, 'brands'));
                brands = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name));
                
                const select = document.getElementById('brandFilter');
                brands.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.textContent = b.name;
                    select.appendChild(opt);
                });
            } catch(e) { console.error('Error fetching brands', e); }
        }

        async function fetchProducts() {
            try {
                const snap = await getDocs(collection(db, 'products'));
                allProducts = snap.docs.map(d => d.data());
            } catch(e) { console.error('Error fetching products', e); }
        }

        function renderProducts(products) {
            const grid = document.getElementById('contentGrid');
            grid.innerHTML = '';

            if (products.length === 0) {
                grid.innerHTML = '<div class="loader">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            // Limit render for performance? 50 items max for now
            const page = products.slice(0, 100);

            page.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const imgUrl = p.imageUrl ? p.imageUrl : ''; 
                // Ensure relative path works for local static file
                // p.imageUrl from migrate.js is like `/products/code.jpg`.
                // For static site in subfolder, if deployed at root, it works. 
                // If local file open, it needs relative `products/code.jpg` (no leading slash).
                // Let's fix leading slash if using file protocol.
                const cleanImg = imgUrl.startsWith('/') ? '.' + imgUrl : imgUrl;

                card.innerHTML = `
                    <div class="card-img">
                        ${p.imageUrl ? `<img src="${cleanImg}" alt="${p.name}" loading="lazy">` : '<div style="font-size:2rem; color:#d1d5db;">üì∑</div>'}
                    </div>
                    <div class="card-body">
                        <div class="card-badge">${p.partTypeName}</div>
                        <div class="card-title" title="${p.name}">${p.name}</div>
                        <div class="card-footer">
                            <div class="card-code">${p.vendorCode}</div>
                            <div class="card-price">${p.price ? p.price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–ü–æ –∑–∞–ø—Ä–æ—Å—É'}</div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Filtering Logic
        const searchInput = document.getElementById('searchInput');
        const brandFilter = document.getElementById('brandFilter');

        function filter() {
            const q = searchInput.value.toLowerCase();
            const b = brandFilter.value;

            const filtered = allProducts.filter(p => {
                const matchText = p.name.toLowerCase().includes(q) || p.vendorCode.toLowerCase().includes(q);
                const matchBrand = b ? p.compatibleBrandIds.includes(parseInt(b)) : true;
                return matchText && matchBrand;
            });

            renderProducts(filtered);
        }

        searchInput.addEventListener('input', filter);
        brandFilter.addEventListener('change', filter);

    </script>
</body>
</html>
