<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZBOILER - –ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ç–ª–æ–≤</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Sticky Header Wrapper -->
    <div class="sticky-header-wrapper">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="nav-links">
                <a href="#">–ö–∞—Ç–∞–ª–æ–≥</a>
                <a href="#">–ü—Ä–æ–º—ã–≤–∫–∞ —Å–∏—Å—Ç–µ–º</a>
                <a href="#">–£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
            </div>
            <div class="social-links">
                <span style="margin-right:1rem;">–≥. –í–ª–∞–¥–∏–º–∏—Ä, —É–ª. –ì–∞—Å—Ç–µ–ª–ª–æ 8–ê</span>
                <a href="#" title="WhatsApp" style="font-weight:bold;">WA</a>
                <a href="#" title="Telegram" style="font-weight:bold;">TG</a>
                <a href="mailto:info@ezboiler.ru" title="Email" style="font-weight:bold;">@</a>
            </div>
        </div>

        <!-- Main Header -->
        <header class="main-header">
            <a href="/" class="logo">
                <span style="color:black;">EZ</span>BOILER
            </a>
            
            <div class="search-bar">
                <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é...">
            </div>

            <div class="header-actions">
                <div class="cart-btn" id="cartBtn">
                    üõí <span class="cart-count">0</span>
                </div>
            </div>
        </header>

        <!-- Mode Toggle -->
        <div class="mode-toggle-container">
            <div class="mode-toggle">
                <button class="toggle-btn active" data-mode="brands" onclick="setMode('brands')">
                    –ø–æ –±—Ä–µ–Ω–¥–∞–º –∏ –º–æ–¥–µ–ª—è–º
                </button>
                <button class="toggle-btn" data-mode="types" onclick="setMode('types')">
                    –ø–æ —Ç–∏–ø—É –∑–∞–ø—á–∞—Å—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Layout -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <h3 id="sidebarTitle">–ë—Ä–µ–Ω–¥—ã</h3>
            <div id="sidebarContent" class="brand-list">
                <!-- Injected via JS -->
                 <div class="loader" style="font-size:1rem; padding:1rem;">Loading...</div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <!-- Dynamic Views: Brand Grid, Boiler Grid, or Product List -->
             <div class="loader" style="margin-top:2rem;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </main>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-col">
                <h4>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                <ul>
                    <li>+7 (4922) 55-22-88</li>
                    <li>+7 (991) 321-07-33</li>
                    <li>–≥. –í–ª–∞–¥–∏–º–∏—Ä, —É–ª. –ì–∞—Å—Ç–µ–ª–ª–æ 8–ê</li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                <ul>
                    <li><a href="#">–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞</a></li>
                    <li><a href="#">–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–∫—É–ø–∫–∏</a></li>
                    <li><a href="#">–í–æ–∑–≤—Ä–∞—Ç</a></li>
                    <li><a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>–ö–∞—Ç–∞–ª–æ–≥</h4>
                <ul>
                    <li><a href="#">–ó–∞–ø—á–∞—Å—Ç–∏</a></li>
                    <li><a href="#">–ü—Ä–æ–º—ã–≤–∫–∞</a></li>
                    <li><a href="#">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000;">
        <div style="background:white; max-width:600px; margin:5rem auto; padding:2rem; border-radius:0.5rem; max-height:80vh; overflow-y:auto; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 style="font-size:1.5rem; font-weight:bold;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                <button onclick="document.getElementById('cartModal').style.display='none'" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="cartItems"></div>
            <div style="text-align:right; margin-top:1rem; font-weight:bold; font-size:1.2rem;">
                –ò—Ç–æ–≥–æ: <span id="cartTotal">0</span> &#8381;
            </div>
             <button style="width:100%; background:var(--primary); color:white; border:none; padding:1rem; margin-top:1rem; border-radius:0.5rem; font-weight:bold; cursor:pointer;" onclick="alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω (–¥–µ–º–æ)!')">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import firebaseConfig from './config.js';

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error(e);
            alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
        }

        // Global State
        const state = {
            mode: 'brands', // 'brands' or 'types'
            brands: [],
            boilers: [],
            partTypes: [],
            products: [],
            selectedBrandId: null,
            selectedBoilerId: null,
            selectedTypeId: null,
            searchQuery: ''
        };

        let cart = JSON.parse(localStorage.getItem('cart') || '[]');

        // --- Data Fetching ---
        async function loadData() {
            try {
                // Parallel fetch for speed
                const [brandsSnap, boilersSnap, typesSnap, productsSnap] = await Promise.all([
                    getDocs(collection(db, 'brands')),
                    getDocs(collection(db, 'boilers')),
                    getDocs(collection(db, 'part_types')),
                    getDocs(collection(db, 'products')) // Warning: Large collection
                ]);

                // Parse IDs correctly (handling numeric IDs from SQLite migration)
                state.brands = brandsSnap.docs.map(d => ({id: parseInt(d.id) || d.id, ...d.data()}))
                    .sort((a,b) => a.name.localeCompare(b.name));
                
                state.boilers = boilersSnap.docs.map(d => ({id: parseInt(d.id) || d.id, ...d.data()}));
                
                state.partTypes = typesSnap.docs.map(d => ({id: parseInt(d.id) || d.id, ...d.data()}))
                                    .sort((a,b) => a.name.localeCompare(b.name));
                
                state.products = productsSnap.docs.map(d => d.data());

                console.log('Data loaded:', state);
                
                // Initial Render
                renderSidebar();
                renderMain();
                updateCart();

            } catch (e) {
                console.error("Load Error:", e);
                document.getElementById('mainContent').innerHTML = `<div class="loader" style="color:red">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${e.message}</div>`;
            }
        }

        // --- Render Functions ---

        // 1. Sidebar Render
        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            const title = document.getElementById('sidebarTitle');
            container.innerHTML = '';

            if (state.mode === 'brands') {
                title.textContent = '–ë—Ä–µ–Ω–¥—ã';
                state.brands.forEach(brand => {
                    const el = document.createElement('div');
                    el.className = `brand-item ${state.selectedBrandId == brand.id ? 'active' : ''}`;
                    // Placeholder for logo if missing, or use text
                    el.innerHTML = `<span>${brand.name}</span>`;
                    el.onclick = () => selectBrand(brand.id);
                    container.appendChild(el);
                });
            } else {
                title.textContent = '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏';
                state.partTypes.forEach(type => {
                     const el = document.createElement('div');
                    el.className = `brand-item ${state.selectedTypeId == type.id ? 'active' : ''}`;
                    el.innerHTML = `<span>${type.name}</span>`;
                    el.onclick = () => selectType(type.id);
                    container.appendChild(el);
                });
            }
        }

        // 2. Main Content Render
        function renderMain() {
            const container = document.getElementById('mainContent');
            container.innerHTML = '';

            // CASE: Search Active?
            if (state.searchQuery.length > 2) {
                renderSearchResults(container);
                return;
            }

            // CASE: Mode = Brands
            if (state.mode === 'brands') {
                if (!state.selectedBrandId) {
                    container.innerHTML = '<div class="loader">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞</div>';
                    // Auto-select first brand?
                    if (state.brands.length > 0 && !isMobile()) selectBrand(state.brands[0].id);
                    return;
                }

                if (state.selectedBoilerId) {
                     // Show Products for Boiler
                     renderProductsForBoiler(container);
                } else {
                    // Show Boilers Grid for Brand
                    renderBoilersGrid(container);
                }
            } 
            // CASE: Mode = Types
            else {
                 if (!state.selectedTypeId) {
                      container.innerHTML = '<div class="loader">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div>';
                      if (state.partTypes.length > 0 && !isMobile()) selectType(state.partTypes[0].id);
                     return;
                 }
                 renderProductsForType(container);
            }
        }
        
        function isMobile() { return window.innerWidth < 800; }

        function renderBoilersGrid(container) {
            const brand = state.brands.find(b => b.id == state.selectedBrandId);
            
            const header = document.createElement('div');
            header.className = 'view-header';
            header.innerHTML = `<h2>–ë–æ–π–ª–µ—Ä—ã ${brand ? brand.name : ''}</h2>`;
            container.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'grid-boilers';

            // Filter boilers by brand
            const boilers = state.boilers.filter(b => b.brand_id == state.selectedBrandId); // assuming brand_id exists

            if (boilers.length === 0) {
                 grid.innerHTML = '<div>–ù–µ—Ç –º–æ–¥–µ–ª–µ–π –∫–æ—Ç–ª–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –±—Ä–µ–Ω–¥–∞</div>';
            } else {
                boilers.forEach(b => {
                    const card = document.createElement('div');
                    card.className = 'boiler-card';
                    card.innerHTML = `
                        <div class="boiler-icon">üî•</div>
                        <div class="boiler-name">${b.name}</div>
                    `;
                    card.onclick = () => selectBoiler(b.id);
                    grid.appendChild(card);
                });
            }
            container.appendChild(grid);
        }

        function renderProductsForBoiler(container) {
             const boiler = state.boilers.find(b => b.id == state.selectedBoilerId);
             
             const header = document.createElement('div');
             header.className = 'view-header';
             header.style.display = 'flex';
             header.style.justifyContent = 'space-between';
             header.innerHTML = `
                <div style="display:flex; align-items:center; gap:1rem;">
                    <div class="back-btn" onclick="selectBoiler(null)">‚Üê –ù–∞–∑–∞–¥</div>
                    <h2>–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è ${boiler ? boiler.name : ''}</h2>
                </div>
             `;
             container.appendChild(header);

             // Find products compatible with this boiler
             // Data structure: product.compatibleBoilerIds (array of ints)
             const products = state.products.filter(p => 
                p.compatibleBoilerIds && p.compatibleBoilerIds.includes(parseInt(state.selectedBoilerId))
             );

             renderProductGrid(container, products);
        }

        function renderProductsForType(container) {
             const type = state.partTypes.find(t => t.id == state.selectedTypeId);
             
             const header = document.createElement('div');
             header.className = 'view-header';
             header.innerHTML = `<h2>${type ? type.name : ''}</h2>`;
             container.appendChild(header);
            
            // Filter by partTypeId
            // We use loose comparison == for ID in case of string vs int mismatch
            const products = state.products.filter(p => p.partTypeId == state.selectedTypeId);
            renderProductGrid(container, products);
        }

        function renderSearchResults(container) {
            const q = state.searchQuery.toLowerCase();
            const products = state.products.filter(p => 
                p.name.toLowerCase().includes(q) || 
                p.vendorCode.toLowerCase().includes(q)
            );
            
            const header = document.createElement('div');
            header.className = 'view-header';
            header.innerHTML = `<h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: "${state.searchQuery}" (${products.length})</h2>`;
            container.appendChild(header);
            
            renderProductGrid(container, products);
        }

        function renderProductGrid(container, products) {
            const grid = document.createElement('div');
            grid.className = 'grid-products';
            
            if (products.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#888;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            } else {
                products.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    
                    const cleanImg = p.imageUrl && p.imageUrl.startsWith('/') ? '.' + p.imageUrl : p.imageUrl;
                    
                    card.innerHTML = `
                        <div class="product-badge">${p.partTypeName || ''}</div>
                        <div class="product-img">
                            ${p.imageUrl ? `<img src="${cleanImg}" alt="${p.name}" loading="lazy">` : '<div style="font-size:3rem; color:#e5e7eb;">üì∑</div>'}
                        </div>
                        <div class="product-body">
                            <div class="product-title" title="${p.name}">${p.name}</div>
                            <div class="product-meta">${p.vendorCode}</div>
                            <div class="product-footer">
                                <div class="product-price">${p.price ? p.price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–ü–æ –∑–∞–ø—Ä–æ—Å—É'}</div>
                                <button class="add-btn" onclick="window.addToCart('${p.vendorCode}')">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }
            container.appendChild(grid);
        }

        // --- Interactive State Mutations ---

        window.setMode = (mode) => {
            state.mode = mode;
            state.selectedBoilerId = null; // Reset selection
            // Update Toggle UI
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            renderSidebar();
            renderMain();
        };

        window.selectBrand = (id) => {
            state.selectedBrandId = id;
            state.selectedBoilerId = null; // Reset boiler when brand changes
            renderSidebar(); // Update active state
            renderMain();
        };

        window.selectBoiler = (id) => {
            state.selectedBoilerId = id;
            renderMain();
        };

        window.selectType = (id) => {
            state.selectedTypeId = id;
            renderSidebar();
            renderMain();
        };

        // --- Cart Logic (Ported) ---
        window.addToCart = (vendorCode) => {
             const product = state.products.find(p => p.vendorCode === vendorCode);
            if (!product) return;
            
            const existing = cart.find(i => i.vendorCode === vendorCode);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({...product, qty: 1});
            }
            updateCart();
            // Optional: Show toast
        };

        window.removeFromCart = (vendorCode) => {
            cart = cart.filter(i => i.vendorCode !== vendorCode);
            updateCart();
            renderCartModal();
        };

        function updateCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            const count = cart.reduce((acc, item) => acc + item.qty, 0);
            document.querySelector('.cart-count').textContent = count;
        }

        function renderCartModal() {
            const container = document.getElementById('cartItems');
            let total = 0;
            if (cart.length === 0) {
                 container.innerHTML = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
            } else {
                container.innerHTML = cart.map(item => {
                    const absTotal = (item.price || 0) * item.qty;
                    total += absTotal;
                    return `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:0.5rem 0;">
                        <div>
                            <div style="font-weight:bold;">${item.name}</div>
                            <div style="font-size:0.8rem; color:#666;">${item.vendorCode}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:1rem;">
                            <span>${item.qty} —à—Ç x ${item.price} &#8381;</span>
                             <button onclick="window.removeFromCart('${item.vendorCode}')" style="color:red; border:none; background:none; cursor:pointer;">&times;</button>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('cartTotal').textContent = total.toLocaleString('ru-RU');
        }

        document.getElementById('cartBtn').addEventListener('click', () => {
            renderCartModal();
            document.getElementById('cartModal').style.display = 'block';
        });

        // --- Search ---
        document.getElementById('searchInput').addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            renderMain();
        });

        // Init
        loadData();

    </script>
</body>
</html>
