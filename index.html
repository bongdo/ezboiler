<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZBOILER - –ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ç–ª–æ–≤</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Local Data for Hardcoded Navigation -->
    <script src="data.js"></script>
</head>
<body>
    
    <!-- Sticky Header System -->
    <div class="sticky-container">
        <div class="main-header-block">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="nav-links">
                    <a href="#" onclick="setView('home')">–ö–∞—Ç–∞–ª–æ–≥</a>
                    <a href="#">–ü—Ä–æ–º—ã–≤–∫–∞ —Å–∏—Å—Ç–µ–º</a>
                    <a href="#">–£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
                </div>
                <div class="social-links">
                    <a href="https://yandex.com.tr/maps/-/CLcf7W3G" target="_blank" style="display:flex; align-items:center; gap:0.5rem; color:inherit;">
                        <img src="images/logo.svg" alt="Map" style="width:16px;"> <!-- Placeholder or real if SVG works -->
                         –ì. –í–ª–∞–¥–∏–º–∏—Ä, —É–ª. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ, 9
                    </a>
                    <a href="#" title="WhatsApp"><img src="images/whatsapp.svg" class="social-icon" alt="WA"></a>
                    <a href="#" title="Telegram"><img src="images/telegram.svg" class="social-icon" alt="TG"></a>
                </div>
            </div>

            <!-- Main Header -->
            <header class="main-header">
                <a href="#" onclick="location.reload()" class="logo">
                     <!-- Using text for Main Logo as per design, or svg if available -->
                    <span style="color:black;">EZ</span>BOILER
                </a>
                
                <div class="search-bar">
                    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é...">
                </div>

                <div class="header-actions">
                    <button class="add-btn" onclick="openCallbackModal()" style="border-radius:2rem;">–ó–∞–∫–∞–∑–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
                    <div class="cart-btn" id="cartBtn">
                        üõí <span class="cart-count">0</span>
                    </div>
                </div>
            </header>
        </div>

        <!-- Transparent Toggle Bar -->
        <div class="sub-header">
            <div class="mode-toggle">
                <button class="toggle-btn active" data-mode="brands" onclick="setMode('brands')">
                    –ü–æ –±—Ä–µ–Ω–¥–∞–º –∏ –º–æ–¥–µ–ª—è–º
                </button>
                <button class="toggle-btn" data-mode="types" onclick="setMode('types')">
                    –ü–æ —Ç–∏–ø—É –∑–∞–ø—á–∞—Å—Ç–∏
                </button>
            </div>
            
            <div class="filters-row">
                <select id="filterBrand" class="filter-select" onchange="applyFilters()">
                    <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
                    <!-- Filled by JS -->
                </select>
                <select id="filterType" class="filter-select" onchange="applyFilters()">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="original">–û—Ä–∏–≥–∏–Ω–∞–ª</option>
                    <option value="analog">–ê–Ω–∞–ª–æ–≥</option>
                </select>
                <select id="filterCondition" class="filter-select" onchange="applyFilters()">
                    <option value="">–°–æ—Å—Ç–æ—è–Ω–∏–µ</option>
                    <option value="new">–ù–æ–≤–æ–µ</option>
                    <option value="used">–ë/–£</option>
                </select>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar: Always Brands List -->
        <aside class="sidebar" id="sidebar">
            <!-- Filled by JS -->
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dynamic Content -->
            <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </main>
    </div>

    <!-- Footer -->
    <footer>
        <div style="max-width:1200px; margin:0 auto; display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:2rem;">
            <div>
                <h4>EZBOILER</h4>
                <p>–í–∞—à –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä –≤ –º–∏—Ä–µ –∑–∞–ø—á–∞—Å—Ç–µ–π –¥–ª—è –∫–æ—Ç–ª–æ–≤.</p>
                <div style="margin-top:1rem; display:flex; gap:1rem;">
                    <img src="images/whatsapp.svg" width="24">
                    <img src="images/telegram.svg" width="24">
                </div>
            </div>
            <div>
                <h4>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                <ul style="opacity:0.8; line-height:1.8;">
                    <li>+7 (4922) 55-22-88</li>
                    <li>–≥. –í–ª–∞–¥–∏–º–∏—Ä, —É–ª. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ, 9</li>
                    <li>info@ezboiler.ru</li>
                </ul>
            </div>
        </div>
    </footer>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content anim-slide-in">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <h2 style="font-size:1.5rem; font-weight:800;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                <button onclick="closeCart()" style="border:none; bg:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="cartItems" style="flex-grow:1; overflow-y:auto;"></div>
            <div style="margin-top:auto; padding-top:1rem; border-top:1px solid #f3f4f6;">
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:bold; margin-bottom:1rem;">
                    <span>–ò—Ç–æ–≥–æ:</span>
                    <span id="cartTotal">0 ‚ÇΩ</span>
                </div>
                <button style="width:100%; padding:1rem; background:var(--primary); color:white; border:none; border-radius:0.5rem; font-weight:bold; cursor:pointer;" onclick="alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!')">
                    –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                </button>
            </div>
        </div>
    </div>

    <!-- Call Modal -->
    <div id="callModal" class="modal" onclick="if(event.target===this)this.style.display='none'">
        <div style="background:white; max-width:400px; margin:10vh auto; padding:2rem; border-radius:1rem; text-align:center;">
             <h2>–ó–∞–∫–∞–∑–∞—Ç—å –∑–≤–æ–Ω–æ–∫</h2>
             <input type="tel" placeholder="+7 (___) ___-__-__" style="width:100%; padding:1rem; margin:1rem 0; border:1px solid #ddd; border-radius:0.5rem;">
             <button style="width:100%; padding:1rem; background:var(--primary); color:white; border:none; border-radius:0.5rem;" onclick="alert('–ú—ã –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–º!');document.getElementById('callModal').style.display='none'">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>


    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import firebaseConfig from './config.js';

        // Init
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State
        const state = {
            mode: 'brands',
            brand: null, // Current selected brand
            boiler: null, // Current selected boiler model
            allProducts: [],
            visibleProducts: [],
            cart: JSON.parse(localStorage.getItem('cart') || '[]'),
            page: 1,
            perPage: 30
        };

        // DOM Elements
        const main = document.getElementById('mainContent');
        const sidebar = document.getElementById('sidebar');

        // --- Core Logic ---

        async function init() {
            renderSidebar(); // Uses DATA from data.js
            
            // Set initial filter options
            const brandSelect = document.getElementById('filterBrand');
            DATA.brands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.name;
                opt.textContent = b.name;
                brandSelect.appendChild(opt);
            });

            // Load products in background
            try {
                const snap = await getDocs(collection(db, 'products'));
                state.allProducts = snap.docs.map(d => d.data());
                console.log('Products loaded:', state.allProducts.length);
            } catch (e) {
                console.error("DB Error:", e);
            }

            // Default View
            setMode('brands'); // Initially just brands
            updateCartCount();
        }

        // --- Rendering ---

        window.setMode = (mode) => {
            state.mode = mode;
            state.brand = null;
            state.boiler = null;
            
            // Update Toggles
            document.querySelectorAll('.toggle-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.mode === mode);
            });

            if (mode === 'brands') {
                renderBoilersGrid(null); // Actually render Brands Select Instruction or Grid of BOILERS?
                // Request: "Brand click -> Grid of Boilers".
                // Default state: Select a brand from sidebar OR show all brands tiles?
                renderBrandTiles();
            } else {
                renderTypesTiles();
            }
        };

        function renderSidebar() {
            sidebar.innerHTML = '';
            DATA.brands.forEach(b => {
                const row = document.createElement('div');
                row.className = 'brand-list-item';
                // Try to find image
                const imgName = b.name + '.png';
                row.innerHTML = `
                    <div style="width:30px; text-align:center;">
                        <img src="images/${imgName}" onerror="this.style.display='none'" style="max-width:100%; max-height:20px;">
                    </div>
                    <span>${b.name}</span>
                `;
                row.onclick = () => selectBrand(b.name);
                sidebar.appendChild(row);
            });
        }

        function renderBrandTiles() {
            main.innerHTML = '<h2 style="margin-bottom:1.5rem;">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</h2>';
            const grid = document.createElement('div');
            grid.className = 'grid-boilers';
            
            DATA.brands.forEach(b => {
                const card = document.createElement('div');
                card.className = 'boiler-card';
                card.innerHTML = `
                    <img src="images/${b.name}.png" onerror="this.src=''" style="height:60px; object-fit:contain; margin-bottom:1rem;">
                    <div class="boiler-name">${b.name}</div>
                `;
                card.onclick = () => selectBrand(b.name);
                grid.appendChild(card);
            });
            main.appendChild(grid);
        }

        function renderTypesTiles() {
             main.innerHTML = '<h2 style="margin-bottom:1.5rem;">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–ø—á–∞—Å—Ç–µ–π</h2>';
             const grid = document.createElement('div');
             grid.className = 'grid-boilers'; // reuse style
             
             DATA.partTypes.forEach(t => {
                 const card = document.createElement('div');
                 card.className = 'boiler-card';
                 card.innerHTML = `<div class="boiler-name">${t}</div>`;
                 card.onclick = () => { applyFilters({type: t}); renderProductList(); }; // TODO: Direct filter
                 grid.appendChild(card);
             });
             main.appendChild(grid);
        }

        window.selectBrand = (brandName) => {
            state.brand = brandName;
            state.mode = 'brands'; // Ensure mode
            // Highlight sidebar
            document.querySelectorAll('.brand-list-item').forEach(el => {
                el.classList.toggle('active', el.innerText.includes(brandName));
            });
            
            // Hardcoded Boiler Grid
            const brandData = DATA.brands.find(b => b.name === brandName);
            
            main.innerHTML = `
                <div style="display:flex; align-items:center; gap:1rem; margin-bottom:2rem;">
                    <h2 style="margin:0;">–ö–æ—Ç–ª—ã ${brandName}</h2>
                </div>
            `;

            if (brandData && brandData.models) {
                const grid = document.createElement('div');
                grid.className = 'grid-boilers';
                brandData.models.forEach(model => {
                    const card = document.createElement('div');
                    card.className = 'boiler-card';
                    card.innerHTML = `
                        <div class="boiler-card-icon">üî•</div>
                        <div class="boiler-name">${model}</div>
                    `;
                    card.onclick = () => selectBoiler(model);
                    grid.appendChild(card);
                });
                main.appendChild(grid);
            } else {
                main.innerHTML += '<div>–ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            }
        };

        window.selectBoiler = (modelName) => {
            state.boiler = modelName;
            state.page = 1;
            renderProductList();
        };

        // --- Product List Logic ---

        window.renderProductList = () => {
            // Apply Filters
            let filtered = state.allProducts;
            
            // 1. Boiler Filter (Strict)
            if (state.boiler) {
                 // The products usually have 'compatibleModels' text string or we fuzzy match name?
                 // Current data has 'compatibleBoilerIds'. 
                 // However, we are using DATA.js for names, so we don't have IDs for them easily map-able 
                 // UNLESS we map names.
                 // Fallback: Text search in 'description' or 'compatible_models_text' if exists.
                 // Or: Filter by Brand ID (we can look up brand ID from Firestore data) + fuzzy match.
                 // For now, let's just filter by Brand strictly + Name Match?
                 // User said: "clicking on boiler tiles opens list with filters set".
                 filtered = filtered.filter(p => JSON.stringify(p).includes(state.boiler) || (p.compatibleBoilerNames || []).includes(state.boiler)); 
                 // Note: Ideally migration script populated compatible names. If not, text search is fallback.
            } else if (state.brand) {
                 // Filter by brand name match in product attributes (vendor, brandName, etc)
                 // Assumption: product has 'brandName' or 'compatibleBrandIds'
                 // Let's use simple text match if IDs are messy
                  filtered = filtered.filter(p => (p.brandName === state.brand) || JSON.stringify(p).includes(state.brand));
            }

            // 2. Dropdown Filters
            const typeF = document.getElementById('filterType').value;
            const condF = document.getElementById('filterCondition').value;
            // TODO: Logic for origin/analog/new/used if data supports it.
            
            // Render
            main.innerHTML = `
                <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem;">
                    ${state.boiler ? `<button onclick="selectBrand('${state.brand}')" class="add-btn" style="border:1px solid #ddd; padding:0.25rem 0.5rem;">‚Üê –ù–∞–∑–∞–¥</button>` : ''}
                    <h2>–ó–∞–ø—á–∞—Å—Ç–∏ ${state.boiler || state.brand || '–í—Å–µ'} (${filtered.length})</h2>
                </div>
                <div id="pGrid" class="grid-products"></div>
                <button id="loadMoreBtn" class="load-more-btn" onclick="loadMore()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ</button>
            `;

            state.visibleProducts = filtered;
            state.page = 1;
            appendProducts();
        };

        window.loadMore = () => {
            state.page++;
            appendProducts();
        };

        function appendProducts() {
            const container = document.getElementById('pGrid');
            const start = (state.page - 1) * state.perPage;
            const end = start + state.perPage;
            const slice = state.visibleProducts.slice(start, end);

            if (slice.length === 0 && state.page === 1) {
                container.innerHTML = '<div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            }

            slice.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                const cleanImg = p.imageUrl && p.imageUrl.startsWith('/') ? '.' + p.imageUrl : p.imageUrl;
                card.innerHTML = `
                    <div class="product-img">
                        ${p.imageUrl ? `<img src="${cleanImg}" loading="lazy">` : 'üì∑'}
                    </div>
                    <div class="product-body">
                        <div class="product-title">${p.name}</div>
                        <div class="product-meta">${p.vendorCode}</div>
                        <div class="product-footer">
                            <div class="price-tag">${p.price ? p.price.toLocaleString() + ' ‚ÇΩ' : ''}</div>
                            <button class="add-btn" onclick="addToCart('${p.vendorCode}', this)">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            if (end >= state.visibleProducts.length) {
                const btn = document.getElementById('loadMoreBtn');
                if(btn) btn.style.display = 'none';
            }
        }

        // --- Cart ---
        window.addToCart = (code, btnElement) => {
            const p = state.allProducts.find(x => x.vendorCode === code);
            if(p) {
                const ex = state.cart.find(x => x.vendorCode === code);
                if(ex) ex.qty++; else state.cart.push({...p, qty:1});
                localStorage.setItem('cart', JSON.stringify(state.cart));
                updateCartCount();
                
                // Anim
                if(btnElement) {
                    btnElement.classList.add('anim-pop');
                    btnElement.textContent = '‚úì';
                    setTimeout(() => {
                        btnElement.classList.remove('anim-pop');
                        btnElement.textContent = '–í –∫–æ—Ä–∑–∏–Ω—É';
                    }, 1000);
                }
            }
        };

        function updateCartCount() {
            const c = state.cart.reduce((a,b)=>a+b.qty,0);
            document.querySelector('.cart-count').textContent = c;
        }

        window.openCallbackModal = () => { document.getElementById('callModal').style.display='block'; }
        
        document.getElementById('cartBtn').addEventListener('click', () => {
             const m = document.getElementById('cartModal');
             m.style.display = 'block';
             renderCartItems();
        });
        window.closeCart = () => { document.getElementById('cartModal').style.display='none'; }

        function renderCartItems() {
             const c = document.getElementById('cartItems');
             let t = 0;
             c.innerHTML = state.cart.map(i => {
                 t += (i.price||0)*i.qty;
                 return `<div style="display:flex; justify-content:space-between; padding:1rem 0; border-bottom:1px solid #eee;">
                    <div><b>${i.name}</b><br><span style="font-size:0.8rem; color:#888;">${i.vendorCode}</span></div>
                    <div>${i.qty} x ${i.price} ‚ÇΩ 
                    <button onclick="removeFromCart('${i.vendorCode}')" style="color:red; margin-left:1rem; border:none; bg:none; cursor:pointer;">&times;</button>
                    </div>
                 </div>`;
             }).join('');
             document.getElementById('cartTotal').textContent = t.toLocaleString() + ' ‚ÇΩ';
        }

        window.removeFromCart = (c) => {
            state.cart = state.cart.filter(x => x.vendorCode !== c);
            localStorage.setItem('cart', JSON.stringify(state.cart));
            renderCartItems();
            updateCartCount();
        };

        // Filters
        window.applyFilters = (overrides) => {
             // Basic trigger for re-render for now
             if(state.mode === 'brands' && (state.brand || state.boiler)) {
                 renderProductList();
             }
        };

        init();

    </script>
</body>
</html>
