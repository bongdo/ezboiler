<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ç–ª–æ–≤ | EzBoiler</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <span>–≥. –í–ª–∞–¥–∏–º–∏—Ä, —É–ª. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ, 9</span>
            <div style="display: flex; gap: 1rem;">
                <a href="#" style="color: white; text-decoration: none;">WhatsApp</a>
                <a href="#" style="color: white; text-decoration: none;">Telegram</a>
                <a href="mailto:info@ezboiler.ru" style="color: white; text-decoration: none;">Email</a>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header>
        <div class="main-header">
            <div class="container">
                <a href="/" class="logo">EzBoiler</a>
                
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é...">
                    <span class="search-icon">üîç</span>
                </div>

                <div class="cart-icon" id="cartBtn">
                    üõí
                    <span class="cart-count">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        
        <!-- Controls -->
        <div class="controls">
            <div class="toggle-group" id="viewModeToggle">
                <button class="toggle-btn active" data-mode="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
                <button class="toggle-btn" data-mode="brands">–ü–æ –±—Ä–µ–Ω–¥–∞–º</button>
                <button class="toggle-btn" data-mode="types">–ü–æ —Ç–∏–ø—É</button>
            </div>
            
            <select id="brandFilter" class="toggle-btn" style="border: 1px solid #e5e5e5;">
                <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
            </select>
        </div>

        <div id="contentGrid" class="grid">
            <!-- Content will be injected here -->
             <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
        </div>

    </main>

    <!-- Footer -->
    <footer>
        <div class="container footer-grid">
            <div class="footer-col">
                <h3>–ö–û–ù–¢–ê–ö–¢–´</h3>
                <a href="tel:+74922552288" class="contact-highlight">+7 (4922) 55-22-88</a>
                <a href="tel:+79913210733" class="contact-highlight">+7 (991) 321-07-33</a>
                <p style="margin-top: 1rem;">–≥. –í–ª–∞–¥–∏–º–∏—Ä,<br>—É–ª. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ, 9</p>
                <div style="margin-top: 1rem;">
                    <a href="#">WhatsApp</a>
                    <a href="#">Telegram</a>
                    <a href="mailto:info@ezboiler.ru">Email</a>
                </div>
            </div>

            <div class="footer-col">
                <h3>–ò–ù–§–û–†–ú–ê–¶–ò–Ø</h3>
                <a href="#">–£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏</a>
                <a href="#">–ü—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</a>
                <a href="#">–í–æ–∑–≤—Ä–∞—Ç</a>
                <a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
            </div>

            <div class="footer-col">
                <h3>–ö–ê–¢–ê–õ–û–ì</h3>
                <a href="#">–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ç–ª–æ–≤</a>
                <a href="#">–ü—Ä–æ–º—ã–≤–∫–∞ —Å–∏—Å—Ç–µ–º</a>
                <a href="#">–£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
            </div>
        </div>
    </footer>


    <!-- Cart Modal -->
    <div id="cartModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
        <div style="background:white; max-width:600px; margin:2rem auto; padding:2rem; border-radius:0.5rem; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 style="font-size:1.5rem; font-weight:bold;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                <button onclick="document.getElementById('cartModal').style.display='none'" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="cartItems"></div>
            <div style="text-align:right; margin-top:1rem; font-weight:bold; font-size:1.2rem;">
                –ò—Ç–æ–≥–æ: <span id="cartTotal">0</span> &#8381;
            </div>
             <button style="width:100%; background:var(--primary); color:white; border:none; padding:1rem; margin-top:1rem; border-radius:0.5rem; font-weight:bold; cursor:pointer;" onclick="alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω (–¥–µ–º–æ)!')">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import firebaseConfig from './config.js';

        let db;
        let allProducts = [];
        let brands = [];
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');

        // Expose cart functions global
        window.addToCart = (vendorCode) => {
            const product = allProducts.find(p => p.vendorCode === vendorCode);
            if (!product) return;
            
            const existing = cart.find(i => i.vendorCode === vendorCode);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({...product, qty: 1});
            }
            updateCart();
            alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
        };

        window.removeFromCart = (vendorCode) => {
            cart = cart.filter(i => i.vendorCode !== vendorCode);
            updateCart();
            renderCart();
        };

        function updateCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            const count = cart.reduce((acc, item) => acc + item.qty, 0);
            document.querySelector('.cart-count').textContent = count;
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            if (cart.length === 0) {
                container.innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
                document.getElementById('cartTotal').textContent = '0';
                return;
            }
            
            let total = 0;
            container.innerHTML = cart.map(item => {
                const itemTotal = (item.price || 0) * item.qty;
                total += itemTotal;
                return `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:0.5rem 0;">
                        <div>
                            <div style="font-weight:bold;">${item.name}</div>
                            <div style="font-size:0.8rem; color:#666;">${item.vendorCode}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:1rem;">
                            <span>${item.qty} —à—Ç x ${item.price} &#8381;</span>
                             <button onclick="window.removeFromCart('${item.vendorCode}')" style="color:red; border:none; background:none; cursor:pointer;">&times;</button>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('cartTotal').textContent = total.toLocaleString('ru-RU');
        }

        document.getElementById('cartBtn').addEventListener('click', () => {
            renderCart();
            document.getElementById('cartModal').style.display = 'block';
        });
        
        // Init App with better error handling
        try {
            console.log("Initializing Firebase...");
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            init();
        } catch (e) {
            console.error("Firebase init failed:", e);
            document.getElementById('contentGrid').innerHTML = `<div class="loader" style="color: red;">
                <h3>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                <p>${e.message}</p>
                <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.</p>
            </div>`;
        }

        async function init() {
            try {
                await Promise.all([fetchBrands(), fetchProducts()]);
                renderProducts(allProducts);
                updateCart(); // Init cart count
                console.log("Data loaded successfully");
            } catch (err) {
                 console.error("Data load error:", err);
                 document.getElementById('contentGrid').innerHTML = `<div class="loader" style="color: orange;">
                    <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
                     <p>–í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.</p>
                     <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                     <p>–î–µ—Ç–∞–ª–∏: ${err.message}</p>
                </div>`;
            }
        }

        async function fetchBrands() {
            const snap = await getDocs(collection(db, 'brands'));
            brands = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name));
            
            const select = document.getElementById('brandFilter');
            brands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.name;
                select.appendChild(opt);
            });
        }

        async function fetchProducts() {
            const snap = await getDocs(collection(db, 'products'));
            allProducts = snap.docs.map(d => d.data());
        }

        function renderProducts(products) {
            const grid = document.getElementById('contentGrid');
            grid.innerHTML = '';

            if (products.length === 0) {
                grid.innerHTML = '<div class="loader">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            // Limit render for performance? 50 items max for now
            const page = products.slice(0, 100);

            page.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const imgUrl = p.imageUrl ? p.imageUrl : ''; 
                // Ensure relative path works
                const cleanImg = imgUrl.startsWith('/') ? '.' + imgUrl : imgUrl;

                card.innerHTML = `
                    <div class="card-img">
                        ${p.imageUrl ? `<img src="${cleanImg}" alt="${p.name}" loading="lazy">` : '<div style="font-size:2rem; color:#d1d5db;">üì∑</div>'}
                    </div>
                    <div class="card-body">
                        <div class="card-badge">${p.partTypeName}</div>
                        <div class="card-title" title="${p.name}">${p.name}</div>
                        <div class="card-footer">
                            <div class="card-code">${p.vendorCode}</div>
                            <div class="card-price">${p.price ? p.price.toLocaleString('ru-RU') + ' &#8381;' : '–ü–æ –∑–∞–ø—Ä–æ—Å—É'}</div>
                        </div>
                        <button onclick="window.addToCart('${p.vendorCode}')" style="margin-top:0.5rem; width:100%; border:1px solid var(--primary); background:white; color:var(--primary); padding:0.5rem; border-radius:0.25rem; cursor:pointer; font-weight:bold; transition:all 0.2s;" onmouseover="this.style.background='var(--primary)';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='var(--primary)'">
                            –í –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Filtering Logic
        const searchInput = document.getElementById('searchInput');
        const brandFilter = document.getElementById('brandFilter');

        function filter() {
            const q = searchInput.value.toLowerCase();
            const b = brandFilter.value;

            const filtered = allProducts.filter(p => {
                const matchText = p.name.toLowerCase().includes(q) || p.vendorCode.toLowerCase().includes(q);
                const matchBrand = b ? p.compatibleBrandIds.includes(parseInt(b)) : true;
                return matchText && matchBrand;
            });

            renderProducts(filtered);
        }

        searchInput.addEventListener('input', () => { filter() });
        brandFilter.addEventListener('change', () => { filter() });
        
        // Mode Toggles
        document.querySelectorAll('.toggle-btn[data-mode]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                // Could implement grouping logic here, but for now just filter reset?
                if (e.target.dataset.mode === 'all') {
                     brandFilter.value = '';
                     filter();
                }
            });
        });

    </script>

</body>
</html>
