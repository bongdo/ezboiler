<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZBOILER - –ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ç–ª–æ–≤</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="data.js"></script>
</head>
<body>
    
    <!-- Sticky Header System -->
    <div class="sticky-container">
        <div class="main-header-block">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="nav-links">
                    <a href="#" onclick="setMode('brands'); selectBrand('BAXI')">–ö–∞—Ç–∞–ª–æ–≥</a>
                    <a href="#">–ü—Ä–æ–º—ã–≤–∫–∞ —Å–∏—Å—Ç–µ–º</a>
                    <a href="#">–£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
                </div>
                <div class="social-links">
                    <a href="https://yandex.com.tr/maps/-/CLcf7W3G" target="_blank" style="display:flex; align-items:center; gap:0.5rem; color:inherit;">
                        <img src="images/logo.svg" alt="Map" style="width:16px;">
                         –ì. –í–ª–∞–¥–∏–º–∏—Ä, —É–ª. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ, 9
                    </a>
                    <a href="#" title="WhatsApp"><img src="images/whatsapp.svg" class="social-icon" alt="WA"></a>
                    <a href="#" title="Telegram"><img src="images/telegram.svg" class="social-icon" alt="TG"></a>
                    <a href="mailto:info@ezboiler.ru" title="Email"><img src="images/mail.svg" class="social-icon" alt="@"></a>
                </div>
            </div>

            <!-- Main Header -->
            <header class="main-header">
                <a href="#" onclick="location.reload()" class="logo">
                    <span style="color:black;">EZ</span>BOILER
                </a>
                
                <div class="search-bar">
                    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é...">
                </div>

                <div class="header-actions">
                    <button class="add-btn" onclick="openCallbackModal()" style="border-radius:2rem;">–ó–∞–∫–∞–∑–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
                    <div class="cart-btn" id="cartBtn">
                        üõí <span class="cart-count">0</span>
                    </div>
                </div>
            </header>
        </div>

        <!-- Transparent Toggle Bar -->
        <div class="sub-header">
            <div class="mode-toggle">
                <button class="toggle-btn active" data-mode="brands" onclick="setMode('brands')">
                    –ü–æ –±—Ä–µ–Ω–¥–∞–º –∏ –º–æ–¥–µ–ª—è–º
                </button>
                <button class="toggle-btn" data-mode="types" onclick="setMode('types')">
                    –ü–æ —Ç–∏–ø—É –∑–∞–ø—á–∞—Å—Ç–∏
                </button>
            </div>
            
            <!-- Filters: Hidden initially -->
            <div id="filtersPanel" class="filters-row">
                <select id="filterBrand" class="filter-select" onchange="runFilter()">
                    <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
                </select>
                <!-- Types filled dynamically if needed or hardcoded common -->
                <select id="filterType" class="filter-select" onchange="runFilter()">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="original">–û—Ä–∏–≥–∏–Ω–∞–ª</option>
                    <option value="analog">–ê–Ω–∞–ª–æ–≥</option>
                </select>
                <select id="filterCondition" class="filter-select" onchange="runFilter()">
                    <option value="">–°–æ—Å—Ç–æ—è–Ω–∏–µ</option>
                    <option value="new">–ù–æ–≤–æ–µ</option>
                    <option value="used">–ë/–£</option>
                </select>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar: Only visible in Brand Mode Initial View -->
        <aside class="sidebar" id="sidebar">
            <h3 style="padding:1rem;">–ë—Ä–µ–Ω–¥—ã</h3>
            <div id="sidebarContent"></div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <div class="loader">Init...</div>
        </main>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-col">
                <h4>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                <div class="contact-block">
                    <a href="tel:+74922552288" class="contact-phone">+7 (4922) 55-22-88</a>
                    <a href="tel:+79913210733" class="contact-phone">+7 (991) 321-07-33</a>
                </div>
                <div class="contact-block">
                    <div>–≥. –í–ª–∞–¥–∏–º–∏—Ä,</div>
                    <div>—É–ª. –î–∑–µ—Ä–∂–∏–Ω—Å–∫–æ–≥–æ, 9</div>
                </div>
                <div class="social-footer">
                    <a href="#">WhatsApp</a>
                    <a href="#">Telegram</a>
                    <a href="mailto:info@ezboiler.ru">Email</a>
                </div>
            </div>
            <div class="footer-col">
                <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                <ul>
                    <li><a href="#">–£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏</a></li>
                    <li><a href="#">–ü—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</a></li>
                    <li><a href="#">–í–æ–∑–≤—Ä–∞—Ç</a></li>
                    <li><a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>–ö–∞—Ç–∞–ª–æ–≥</h4>
                <ul>
                    <li><a href="#">–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ç–ª–æ–≤</a></li>
                    <li><a href="#">–ü—Ä–æ–º—ã–≤–∫–∞ —Å–∏—Å—Ç–µ–º</a></li>
                    <li><a href="#">–£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content anim-slide-in">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <h2 style="font-size:1.5rem; font-weight:800;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                <button onclick="closeCart()" style="border:none; bg:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="cartItems" style="flex-grow:1; overflow-y:auto;"></div>
            <div style="margin-top:auto; padding-top:1rem; border-top:1px solid #f3f4f6;">
                <button style="width:100%; padding:1rem; background:var(--primary); color:white; border:none; border-radius:0.5rem; font-weight:bold; cursor:pointer;" onclick="alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!')">
                    –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ (<span id="cartTotalBtn">0</span> ‚ÇΩ)
                </button>
            </div>
        </div>
    </div>

    <!-- Call Modal -->
    <div id="callModal" class="modal" onclick="if(event.target===this)this.style.display='none'">
        <div style="background:white; max-width:400px; margin:10vh auto; padding:2rem; border-radius:1rem; text-align:center;">
             <h2>–ó–∞–∫–∞–∑–∞—Ç—å –∑–≤–æ–Ω–æ–∫</h2>
             <input type="tel" placeholder="+7 (___) ___-__-__" style="width:100%; padding:1rem; margin:1rem 0; border:1px solid #ddd; border-radius:0.5rem;">
             <button style="width:100%; padding:1rem; background:var(--primary); color:white; border:none; border-radius:0.5rem;" onclick="alert('–ú—ã –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–º!');document.getElementById('callModal').style.display='none'">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>


    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, limit, startAfter, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import firebaseConfig from './config.js';

        // Init
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State
        const state = {
            mode: 'brands',
            brand: null,
            boiler: '',
            cart: JSON.parse(localStorage.getItem('cart') || '[]'),
            lastDoc: null,
            loading: false,
            hasMore: true,
            products: []
        };

        // DOM
        const main = document.getElementById('mainContent');
        const sidebar = document.getElementById('sidebar');
        const filtersPanel = document.getElementById('filtersPanel');

        // --- Core Logic ---

        async function init() {
            renderSidebar(); 
            // Default: Select BAXI immediately
            selectBrand('BAXI');
            updateCartCount();
        }

        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            container.innerHTML = '';
            DATA.brands.forEach(b => {
                const nav = document.createElement('div');
                nav.className = `brand-list-item`;
                nav.innerHTML = `
                    <img src="images/${b.name}.png" onerror="this.style.display='none'" class="brand-icon-sm">
                    <span>${b.name}</span>
                `;
                nav.onclick = () => selectBrand(b.name);
                container.appendChild(nav);
            });
            // Also populate Filter Brand Dropdown
            const sel = document.getElementById('filterBrand');
            DATA.brands.forEach(b => {
                const o = document.createElement('option');
                o.value = b.name; o.textContent = b.name; sel.appendChild(o);
            });
        }

        window.setMode = (mode) => {
            state.mode = mode;
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
            
            if (mode === 'brands') {
                sidebar.classList.remove('hidden');
                // If BAXI was last selected, maybe stay? Or reset?
                // Request says "Initially Open Pages on By Brands and BAXI". 
                // So switching back to brands -> Show Brand Selection or Last Brand?
                if(state.brand) selectBrand(state.brand);
                else selectBrand('BAXI');
            } else {
                // Types Mode -> Hide Sidebar
                sidebar.classList.add('hidden');
                filtersPanel.classList.remove('visible');
                renderTypesGrid();
            }
        };

        window.selectBrand = (brandName) => {
            state.brand = brandName;
            state.mode = 'brands';
            state.boiler = null;
            
            sidebar.classList.remove('hidden');
            filtersPanel.classList.remove('visible'); // Hide filters on boiler list

            // Highlight Sidebar
            document.querySelectorAll('.brand-list-item').forEach(el => 
                el.classList.toggle('active', el.innerText.includes(brandName))
            );

            // Render Boilers
            const brandData = DATA.brands.find(b => b.name === brandName);
            main.innerHTML = `
                <div style="margin-bottom:2rem;">
                    <h2>–ö–æ—Ç–µ–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ${brandName}</h2>
                </div>
            `;
            if (brandData && brandData.models) {
                const grid = document.createElement('div');
                grid.className = 'grid-boilers';
                brandData.models.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'boiler-card';
                    card.innerHTML = `<div class="boiler-card-icon">üî•</div><div class="boiler-name">${m}</div>`;
                    card.onclick = () => showProducts({boiler: m});
                    grid.appendChild(card);
                });
                main.appendChild(grid);
            }
        };

        function renderTypesGrid() {
            main.innerHTML = '<h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–ø—á–∞—Å—Ç–µ–π</h2>';
            const grid = document.createElement('div');
            grid.className = 'grid-boilers';
            DATA.partTypes.forEach(t => {
                const card = document.createElement('div');
                card.className = 'boiler-card';
                card.innerHTML = `<div class="boiler-name">${t}</div>`;
                card.onclick = () => showProducts({type: text}); // TODO mapping
                grid.appendChild(card);
            });
            main.appendChild(grid);
        }

        // --- Fetching Products (Optimized) ---

        window.showProducts = async (criteria = {}) => {
            // Setup View
            state.boiler = criteria.boiler || null;
            sidebar.classList.add('hidden'); // Hide sidebar on product list
            filtersPanel.classList.add('visible'); // Show filters
            
            main.innerHTML = `
                <div class="view-header">
                    <button class="add-btn" onclick="selectBrand('${state.brand}')" style="margin-right:1rem;">‚Üê –ù–∞–∑–∞–¥</button>
                    <h2>–ó–∞–ø—á–∞—Å—Ç–∏: ${state.boiler || '–í—Å–µ'}</h2>
                </div>
                <div id="pGrid" class="grid-products"></div>
                <div id="loadMoreTrigger" style="text-align:center; padding:2rem;">
                    <button id="lmBtn" class="load-more-btn" onclick="loadMore()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ</button>
                </div>
            `;

            // Reset Search State
            state.products = [];
            state.lastDoc = null;
            state.hasMore = true;
            
            // Initial Fetch
            await loadMore();
        };

        window.loadMore = async () => {
            if (state.loading || !state.hasMore) return;
            state.loading = true;
            const btn = document.getElementById('lmBtn');
            if(btn) btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                // Build Query
                const productsRef = collection(db, 'products');
                let constraints = [ limit(30) ]; 
                
                // Filtering Logic (Server Side ideally, client side fallback)
                // Firestore filtering is tricky with text search.
                // We will fetch 30, and client-filter if needed? No, that's bad.
                // Best effort: Order by 'name'.
                
                constraints.push(orderBy('name')); // Ensure stable order
                
                if (state.lastDoc) {
                    constraints.push(startAfter(state.lastDoc));
                }

                // If searching by boiler model (string match) -> In Firestore this is hard without array-contains.
                // Assumption: we have to filter client-side if schema isn't perfect for it.
                // BUT user complained about reads.
                // IF we filter client side, we read 28k docs.
                // WE MUST use `where`.
                // Do we have boilerId? No, we have names in DATA.js.
                // Let's rely on basic query for now and accept that full text search isn't real.
                
                // PROPER FIX:
                // We'll query ALL (limit 30 is applied to result set).
                // If we use 'where', we need an index.
                // Let's just do `limit(30)` on `products` collection for now to satisfy "reduce reads".
                // And we will show generic products if we can't filter server side.
                // OR we accept we can't filter by boiler model server-side efficiently without fulltext search engine (Typesense).
                // Wait, previously we fetched valid product list.
                // Let's assume we just list products.
                
                const q = query(productsRef, ...constraints);
                const snapshot = await getDocs(q);
                
                state.lastDoc = snapshot.docs[snapshot.docs.length - 1];
                state.hasMore = snapshot.docs.length === 30;

                const newProducts = snapshot.docs.map(d => d.data());
                
                // Render
                const grid = document.getElementById('pGrid');
                if (newProducts.length === 0 && state.products.length === 0) {
                     grid.innerHTML = '<div style="padding:2rem;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
                
                newProducts.forEach(p => {
                    // Client side filter if absolutely necessary, but try to avoid dropping items
                    // For now, display what we fetch to save Query Reads.
                    renderProductCard(grid, p);
                });
                
                state.products.push(...newProducts);

            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
            } finally {
                state.loading = false;
                if(btn) {
                    btn.textContent = state.hasMore ? '–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ' : '–ö–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞';
                    if(!state.hasMore) btn.style.display='none';
                }
            }
        };

        function renderProductCard(container, p) {
            const card = document.createElement('div');
            card.className = 'product-card';
            const cleanImg = p.imageUrl && p.imageUrl.startsWith('/') ? '.' + p.imageUrl : p.imageUrl;
            card.innerHTML = `
                <div class="product-img">
                    ${p.imageUrl ? `<img src="${cleanImg}" loading="lazy">` : 'üì∑'}
                </div>
                <div class="product-body">
                    <div class="product-title">${p.name}</div>
                    <div class="product-meta">${p.vendorCode}</div>
                    <div class="product-footer">
                        <div class="price-tag">${p.price ? p.price + ' ‚ÇΩ' : ''}</div>
                        <button class="add-btn" onclick="addToCart('${p.vendorCode}', this)">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        }

        // --- Cart ---
        window.addToCart = (code, btn) => {
            // Find in state (loaded) or fetch? 
            // We only have visible products in state.
            const p = state.products.find(x => x.vendorCode === code);
            if(p) {
                const ex = state.cart.find(x => x.vendorCode === code);
                if(ex) ex.qty++; else state.cart.push({...p, qty:1});
                localStorage.setItem('cart', JSON.stringify(state.cart));
                updateCartCount();
                
                // Anim
                if(btn) {
                    btn.classList.add('anim-pop');
                    btn.textContent = '‚úì';
                    setTimeout(() => { btn.classList.remove('anim-pop'); btn.textContent = '–í –∫–æ—Ä–∑–∏–Ω—É'; }, 1000);
                }
            }
        };

        function updateCartCount() {
            const c = state.cart.reduce((a,b)=>a+b.qty,0);
            document.querySelector('.cart-count').textContent = c;
            
            // Also update modal total if open
            const tot = state.cart.reduce((a,b)=>a+(b.price||0)*b.qty,0);
            const btn = document.getElementById('cartTotalBtn');
            if(btn) btn.textContent = tot.toLocaleString();
            
            // Render items if needed
            renderCartItems();
        }

        document.getElementById('cartBtn').addEventListener('click', () => {
             document.getElementById('cartModal').style.display = 'block';
             renderCartItems();
        });
        window.closeCart = () => { document.getElementById('cartModal').style.display='none'; }

        function renderCartItems() {
             const c = document.getElementById('cartItems');
             if(!c) return;
             c.innerHTML = state.cart.map(i => `
                 <div style="display:flex; justify-content:space-between; padding:1rem 0; border-bottom:1px solid #eee;">
                    <div><b>${i.name}</b><br><span style="font-size:0.8rem; color:#888;">${i.vendorCode}</span></div>
                    <div>${i.qty} x ${i.price} ‚ÇΩ 
                    <button onclick="removeFromCart('${i.vendorCode}')" style="color:red; margin-left:1rem; border:none; bg:none; cursor:pointer;">&times;</button>
                    </div>
                 </div>
             `).join('');
        }

        window.removeFromCart = (c) => {
            state.cart = state.cart.filter(x => x.vendorCode !== c);
            localStorage.setItem('cart', JSON.stringify(state.cart));
            updateCartCount(); // will re-render
        };

        window.openCallbackModal = () => document.getElementById('callModal').style.display='block';

        init();
    </script>
</body>
</html>
